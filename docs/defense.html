<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>TekkenPedia</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <link href="styles/styles.css" rel="stylesheet">
        <link rel="icon" type="image/png" href="images/favicon.png" />

        <style>
            .overlay {
                position: absolute;
                bottom: 0;
                margin: auto;
                height: 150px;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            }
            .overlay p {
                font-size: 6rem;
            }
            .video-container {
                position: relative;
                width: 100%;
            }
            video {
                width: 100%;
                display: block;
            }
        </style>
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div class="col-12 video-container">
                    <video src="images/characters/alisa-bosconovitch/defense/3c3fa71f-9900-424f-b898-03a1382ac6a6-5000k.mp4"
                           class="d-none w-100"
                           id="video1"
                           data-first-action-frame="74"
                           data-last-action-frame="85"
                           data-inputs="1"></video>
                    <video src="images/characters/alisa-bosconovitch/defense/4dbbc769-9206-4767-8a00-43c8355b7fe0-5000k.mp4"
                           class="d-none w-100"
                           id="video2"></video>
                    <video src="images/characters/alisa-bosconovitch/defense/200404e1-f529-4c28-9bad-c16558006c87-5000k.mp4"
                           class="d-none w-100"
                           id="video3"></video>
                    <video src="images/characters/alisa-bosconovitch/defense/ce6521f9-0586-4089-89ad-c894841969e3-5000k.mp4"
                           class="d-none w-100"
                           id="video4"></video>
                    <div class="overlay d-none alert alert-warning" id="result-too-early" role="alert">
                        <p>Trop tôt.</p>
                    </div>
                    <div class="overlay d-none alert alert-success" id="result-ok" role="alert">
                        <p>Déchoppe ok.</p>
                    </div>
                    <div class="overlay d-none alert alert-danger" id="result-too-late" role="alert">
                        <p>Trop tard.</p>
                    </div>
                </div>
            </div>

            <button id="start">Gogo la revolution !</button>
            <div id="test"></div>
            <div id="frame">qsdqsdqsdqsdsqd</div>
        </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        let gamepadIndex = null;

        window.addEventListener("gamepadconnected", function(event) {
            gamepadIndex = event.gamepad.index;
            console.log("Gamepad connected at index " + gamepadIndex);
        });

        window.addEventListener("gamepaddisconnected", function(event) {
            console.log("Gamepad disconnected from index " + event.gamepad.index);
            if (gamepadIndex === event.gamepad.index) {
                gamepadIndex = null;
            }
        });

        function updateGamepadStatus() {
            let currentFrame = Math.floor($video.get(0).currentTime * 60);
            $('#frame').text(currentFrame);

            if (gamepadIndex !== null) {
                const gamepad = navigator.getGamepads()[gamepadIndex];
                let statusMessage = '';

                let pressedButtons = [];
                gamepad.buttons.forEach((button, index) => {
                    if (button.pressed) {
                        if (index === 2) {
                            index = 1;
                        }
                        pressedButtons.push(index);
                    }
                });

                if (pressedButtons.length > 0) {
                    if (pressedButtons.join(',') === $video.data('inputs').toString()) {
                        let firstActionFrame = $video.data('first-action-frame');
                        let lastActionFrame = $video.data('last-action-frame');

                        console.log(currentFrame, firstActionFrame, '--------------');

                        if (currentFrame >= firstActionFrame && currentFrame <= lastActionFrame) {
                            $resultTooEarly.addClass('d-none');
                            $resultOk.removeClass('d-none');
                            $resultTooLate.addClass('d-none');
                        } else if (currentFrame < firstActionFrame) {
                            $resultTooEarly.removeClass('d-none');
                            $resultOk.addClass('d-none');
                            $resultTooLate.addClass('d-none');
                        } else if (currentFrame > lastActionFrame) {
                            $resultTooEarly.addClass('d-none');
                            $resultOk.addClass('d-none');
                            $resultTooLate.removeClass('d-none');
                        }
                    }
                }

                gamepad.axes.forEach((axis, index) => {
                    if (Math.abs(axis) > 0.1) {
                        statusMessage += `Axe ${index} : ${axis.toFixed(2)}. `;
                    }
                });
            }

            if ($video.readyState >= 2) {
                document.getElementById('frame').textContent = Math.floor(video.currentTime * 60);
            }
        }

        function gamepadLoop() {
            updateGamepadStatus();
            requestAnimationFrame(gamepadLoop);
        }

        $(function() {
            $video = $('#video1');
            $resultTooEarly = $('#result-too-early');
            $resultOk = $('#result-ok');
            $resultTooLate = $('#result-too-late');

            $('#start').on('click', function () {
                $video.removeClass('d-none');
                $video.get(0).play();

                $resultTooEarly.addClass('d-none');
                $resultOk.addClass('d-none');
                $resultTooLate.addClass('d-none');
            });

            gamepadLoop();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    </body>
</html>
